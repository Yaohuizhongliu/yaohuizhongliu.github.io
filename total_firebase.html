<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>总席位预测 - Firebase版本</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "Hiragino Kaku Gothic Pro", "Meiryo", sans-serif;
    background-color: #202020;
    color: #e0e0e0;
    padding: 20px;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #404040;
}

.back-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 10px 20px;
    background-color: #404040;
    color: #e0e0e0;
    text-decoration: none;
    border-radius: 5px;
    transition: background-color 0.3s;
}

.back-btn:hover {
    background-color: #6090c0;
}

h1 {
    margin: 20px 0;
}

.table-container {
    max-width: 1200px;
    margin: 0 auto;
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

th, td {
    padding: 12px;
    text-align: center;
    border: 1px solid #404040;
}

th {
    background-color: #303030;
    font-weight: bold;
    color: #ffffff;
}

tr:nth-child(even) {
    background-color: #2a2a2a;
}

.party-name {
    text-align: left !important;
    font-weight: bold;
}

input[type="number"] {
    width: 80px;
    padding: 8px;
    text-align: center;
    border: 1px solid #606060;
    background-color: #303030;
    color: #e0e0e0;
    border-radius: 4px;
    font-size: 16px;
}

input[type="number"]:focus {
    outline: none;
    border-color: #6090c0;
}

input[type="text"] {
    padding: 8px 12px;
    text-align: center;
    border: 1px solid #606060;
    background-color: #303030;
    color: #e0e0e0;
    border-radius: 4px;
    font-size: 16px;
    width: 200px;
}

input[type="text"]:focus {
    outline: none;
    border-color: #6090c0;
}

.total-cell {
    background-color: #404060;
    font-weight: bold;
}

.summary {
    margin-top: 40px;
    padding: 20px;
    background-color: #303030;
    border-radius: 10px;
}

.summary h2 {
    color: #6090c0;
    margin-bottom: 15px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #404040;
}

.summary-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #6090c0;
}

.jimin { color: #E080A0; }
.ishin { color: #60C080; }
.chudo { color: #2080C0; }
.kokumin { color: #80E0E0; }
.sansei { color: #E08000; }
.shamin { color: #E0B070; }
.kyosan { color: #E04040; }
.reiwa { color: #E0D0A0; }
.hoshu { color: #8090B0; }
.genzei { color: #B040D0; }
.mirai { color: #E09090; }
.yukoku { color: #C0C0E0; }
.musho { color: #A08060; }

.reset-btn {
    margin-top: 20px;
    padding: 10px 30px;
    background-color: #604040;
    color: #e0e0e0;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
}

.reset-btn:hover {
    background-color: #806060;
}

.submit-section {
    margin-top: 30px;
    padding: 20px;
    background-color: #303030;
    border-radius: 10px;
    text-align: center;
}

.submit-section h2 {
    color: #6090c0;
    margin-bottom: 15px;
}

.submit-inputs {
    display: flex;
    justify-content: center;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.submit-btn {
    padding: 12px 30px;
    background-color: #6090c0;
    color: #ffffff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin-left: 15px;
    transition: background-color 0.3s;
}

.submit-btn:hover {
    background-color: #80b0d0;
}

.submit-btn:disabled {
    background-color: #606060;
    cursor: not-allowed;
}

.submissions-container {
    margin-top: 40px;
    padding: 20px;
    background-color: #303030;
    border-radius: 10px;
}

.submissions-container h2 {
    color: #6090c0;
    margin-bottom: 20px;
}

.submission-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.submission-table th {
    background-color: #404060;
    color: #ffffff;
    padding: 12px;
    text-align: center;
    border: 1px solid #404040;
}

.submission-table td {
    padding: 10px;
    text-align: center;
    border: 1px solid #404040;
}

.submission-table td:first-child {
    text-align: left;
    font-weight: bold;
}

.submission-table tr:hover {
    background-color: #404040;
}

.delete-btn {
    padding: 5px 10px;
    background-color: #604040;
    color: #e0e0e0;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
}

.delete-btn:hover {
    background-color: #804040;
}

.empty-message {
    text-align: center;
    padding: 30px;
    color: #808080;
    font-size: 14px;
}

.loading {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.9);
    color: #fff;
    padding: 20px 40px;
    border-radius: 10px;
    display: none;
    z-index: 9999;
}

.status-message {
    margin-top: 10px;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
    font-size: 14px;
}

.status-success {
    background-color: #406040;
    color: #60C080;
}

.status-error {
    background-color: #604040;
    color: #E04040;
}
</style>
</head>
<body>
    <div class="header">
        <a href="main.html" class="back-btn">← 戻る</a>
        <h1>总席位预测</h1>
    </div>

    <div class="table-container">
        <table id="seatsTable">
            <thead>
                <tr>
                    <th>政党</th>
                    <th>選挙区</th>
                    <th>比例区</th>
                    <th class="total-cell">総計</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="party-name jimin">自由民主党</td>
                    <td><input type="number" class="senkyoku" data-party="jimin" value="0"></td>
                    <td><input type="number" class="hirei" data-party="jimin" value="0"></td>
                    <td class="total-cell" id="total-jimin">0</td>
                </tr>
                <tr>
                    <td class="party-name ishin">日本維新の会</td>
                    <td><input type="number" class="senkyoku" data-party="ishin" value="0"></td>
                    <td><input type="number" class="hirei" data-party="ishin" value="0"></td>
                    <td class="total-cell" id="total-ishin">0</td>
                </tr>
                <tr>
                    <td class="party-name chudo">中道改革連合</td>
                    <td><input type="number" class="senkyoku" data-party="chudo" value="0"></td>
                    <td><input type="number" class="hirei" data-party="chudo" value="0"></td>
                    <td class="total-cell" id="total-chudo">0</td>
                </tr>
                <tr>
                    <td class="party-name kokumin">国民民主党</td>
                    <td><input type="number" class="senkyoku" data-party="kokumin" value="0"></td>
                    <td><input type="number" class="hirei" data-party="kokumin" value="0"></td>
                    <td class="total-cell" id="total-kokumin">0</td>
                </tr>
                <tr>
                    <td class="party-name sansei">参政党</td>
                    <td><input type="number" class="senkyoku" data-party="sansei" value="0"></td>
                    <td><input type="number" class="hirei" data-party="sansei" value="0"></td>
                    <td class="total-cell" id="total-sansei">0</td>
                </tr>
                <tr>
                    <td class="party-name shamin">社会民主党</td>
                    <td><input type="number" class="senkyoku" data-party="shamin" value="0"></td>
                    <td><input type="number" class="hirei" data-party="shamin" value="0"></td>
                    <td class="total-cell" id="total-shamin">0</td>
                </tr>
                <tr>
                    <td class="party-name kyosan">日本共産党</td>
                    <td><input type="number" class="senkyoku" data-party="kyosan" value="0"></td>
                    <td><input type="number" class="hirei" data-party="kyosan" value="0"></td>
                    <td class="total-cell" id="total-kyosan">0</td>
                </tr>
                <tr>
                    <td class="party-name reiwa">れいわ新選組</td>
                    <td><input type="number" class="senkyoku" data-party="reiwa" value="0"></td>
                    <td><input type="number" class="hirei" data-party="reiwa" value="0"></td>
                    <td class="total-cell" id="total-reiwa">0</td>
                </tr>
                <tr>
                    <td class="party-name hoshu">日本保守党</td>
                    <td><input type="number" class="senkyoku" data-party="hoshu" value="0"></td>
                    <td><input type="number" class="hirei" data-party="hoshu" value="0"></td>
                    <td class="total-cell" id="total-hoshu">0</td>
                </tr>
                <tr>
                    <td class="party-name genzei">減税日本</td>
                    <td><input type="number" class="senkyoku" data-party="genzei" value="0"></td>
                    <td><input type="number" class="hirei" data-party="genzei" value="0"></td>
                    <td class="total-cell" id="total-genzei">0</td>
                </tr>
                <tr>
                    <td class="party-name mirai">チームみらい</td>
                    <td><input type="number" class="senkyoku" data-party="mirai" value="0"></td>
                    <td><input type="number" class="hirei" data-party="mirai" value="0"></td>
                    <td class="total-cell" id="total-mirai">0</td>
                </tr>
                <tr>
                    <td class="party-name yukoku">ゆうこく連合</td>
                    <td><input type="number" class="senkyoku" data-party="yukoku" value="0"></td>
                    <td><input type="number" class="hirei" data-party="yukoku" value="0"></td>
                    <td class="total-cell" id="total-yukoku">0</td>
                </tr>
                <tr>
                    <td class="party-name musho">無所属等</td>
                    <td><input type="number" class="senkyoku" data-party="musho" value="0"></td>
                    <td><input type="number" class="hirei" data-party="musho" value="0"></td>
                    <td class="total-cell" id="total-musho">0</td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td class="party-name">合計</td>
                    <td id="total-senkyoku-sum">0</td>
                    <td id="total-hirei-sum">0</td>
                    <td class="total-cell" id="grand-total">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="summary">
            <h2>サマリー</h2>
            <div class="summary-row">
                <span>選挙区席数:</span>
                <span class="summary-value" id="summary-senkyoku">0</span>
            </div>
            <div class="summary-row">
                <span>比例区席数:</span>
                <span class="summary-value" id="summary-hirei">0</span>
            </div>
            <div class="summary-row">
                <span>総獲得席数:</span>
                <span class="summary-value" id="summary-total">0</span>
            </div>
            <div class="summary-row">
                <span>残り席数 (465):</span>
                <span class="summary-value" id="summary-remaining">465</span>
            </div>
        </div>

        <button class="reset-btn" onclick="resetAll()">リセット</button>
    </div>

    <div class="submit-section">
        <h2>予想を提出する</h2>
        <div class="submit-inputs">
            <div>
                <label>氏名</label>
                <input type="text" id="submitterName" placeholder="氏名を入力してください">
            </div>
            <button class="submit-btn" id="submitBtn" onclick="submitPrediction()">提出する</button>
        </div>
    </div>

    <div class="submissions-container">
        <h2>全員の予想</h2>
        <div id="submissionsContent"></div>
    </div>

    <div class="loading" id="loading"></div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyCMhXczea-LUNSbw9A70vYiCIoxopLTAd8",
        authDomain: "senkyo-prediction-2026.firebaseapp.com",
        projectId: "senkyo-prediction-2026",
        storageBucket: "senkyo-prediction-2026.firebasestorage.app",
        messagingSenderId: "406771519192",
        appId: "1:406771519192:web:c5b37f59657e07c3f011ad",
        measurementId: "G-N8Q2SPGC6Z"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        const parties = ['jimin', 'ishin', 'chudo', 'kokumin', 'sansei', 'shamin', 'kyosan', 'reiwa', 'hoshu', 'genzei', 'mirai', 'yukoku', 'musho'];
        const COLLECTION_NAME = 'predictions';

        // 显示加载状态
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // 计算总计
        function calculateTotals() {
            let senkyokuTotal = 0;
            let hireiTotal = 0;
            let grandTotal = 0;

            parties.forEach(party => {
                const senkyoku = parseInt(document.querySelector(`.senkyoku[data-party="${party}"]`).value) || 0;
                const hirei = parseInt(document.querySelector(`.hirei[data-party="${party}"]`).value) || 0;
                const total = senkyoku + hirei;

                document.getElementById(`total-${party}`).textContent = total;
                senkyokuTotal += senkyoku;
                hireiTotal += hirei;
                grandTotal += total;
            });

            document.getElementById('total-senkyoku-sum').textContent = senkyokuTotal;
            document.getElementById('total-hirei-sum').textContent = hireiTotal;
            document.getElementById('grand-total').textContent = grandTotal;

            document.getElementById('summary-senkyoku').textContent = senkyokuTotal;
            document.getElementById('summary-hirei').textContent = hireiTotal;
            document.getElementById('summary-total').textContent = grandTotal;
            document.getElementById('summary-remaining').textContent = 465 - grandTotal;

            const remaining = 465 - grandTotal;
            const remainingEl = document.getElementById('summary-remaining');
            if (remaining < 0) {
                remainingEl.style.color = '#E04040';
            } else if (remaining > 0) {
                remainingEl.style.color = '#6090c0';
            } else {
                remainingEl.style.color = '#60C080';
            }
        }

        function resetAll() {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = 0;
            });
            document.getElementById('submitterName').value = '';
            calculateTotals();
        }

        async function submitPrediction() {
            const name = document.getElementById('submitterName').value.trim();
            if (!name) {
                alert('氏名を入力してください');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            showLoading(true);

            try {
                // 获取数据
                const prediction = {};
                parties.forEach(party => {
                    const senkyoku = parseInt(document.querySelector(`.senkyoku[data-party="${party}"]`).value) || 0;
                    const hirei = parseInt(document.querySelector(`.hirei[data-party="${party}"]`).value) || 0;
                    prediction[party] = { senkyoku, hirei, total: senkyoku + hirei };
                });

                prediction.grandTotal = parseInt(document.getElementById('grand-total').textContent);
                prediction.timestamp = new Date().toISOString();

                // 检查是否已存在同名预测
                const q = query(collection(db, COLLECTION_NAME), where('name', '==', name));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // 更新现有文档
                    const docRef = querySnapshot.docs[0].ref;
                    await setDoc(docRef, {
                        name: name,
                        prediction: prediction,
                        timestamp: prediction.timestamp
                    });
                } else {
                    // 创建新文档
                    await addDoc(collection(db, COLLECTION_NAME, {
                        name: name,
                        prediction: prediction,
                        timestamp: prediction.timestamp
                    });
                }

                showStatus('予想を保存しました！', 'success');
                document.getElementById('submitterName').value = '';
                await displaySubmissions();

            } catch (error) {
                console.error('提交失败:', error);
                showStatus('エラーが発生しました: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                showLoading(false);
            }
        }

        async function displaySubmissions() {
            showLoading(true);

            try {
                const snapshot = await getDocs(collection(db, COLLECTION_NAME));
                const submissionsDiv = document.getElementById('submissionsContent');

                if (snapshot.empty) {
                    submissionsDiv.innerHTML = '<p class="empty-message">まだ予想がありません</p>';
                    showLoading(false);
                    return;
                }

                // 按时间戳排序
                const docs = snapshot.docs.sort((a, b) => 
                    new Date(b.data().timestamp || 0) - new Date(a.data().timestamp || 0)
                );

                let html = '<table class="submission-table"><thead><tr><th>No.</th><th>氏名</th>';
                parties.forEach(party => {
                    html += `<th class="${party}">${getPartyName(party)}</th>`;
                });
                html += '<th style="background-color:#404060">総計</th><th>操作</th></tr></thead><tbody>';

                docs.forEach((docSnap, index) => {
                    const data = docSnap.data();
                    const prediction = data.prediction || {};
                    const date = new Date(data.timestamp || 0).toLocaleString('ja-JP');

                    html += `<tr>
                        <td>${index + 1}</td>
                        <td>${escapeHtml(data.name)}</td>`;

                    parties.forEach(party => {
                        const count = prediction[party]?.total || 0;
                        html += `<td class="${party}">${count}</td>`;
                    });

                    html += `<td style="background-color:#404060"><strong>${data.prediction?.grandTotal || 0}</strong></td>`;
                    html += `<td><button class="delete-btn" onclick="deleteSubmission('${escapeHtml(data.name)}')">削除</button></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                submissionsDiv.innerHTML = html;

            } catch (error) {
                console.error('加载失败:', error);
                showStatus('データの読み込みに失敗しました', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteSubmission(name) {
            if (!confirm(`${name} さんの予想を削除しますか？`)) {
                return;
            }

            showLoading(true);

            try {
                const q = query(collection(db, COLLECTION_NAME), where('name', '==', name));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    await deleteDoc(snapshot.docs[0].ref);
                    showStatus('削除しました', 'success');
                    await displaySubmissions();
                }
            } catch (error) {
                console.error('删除失败:', error);
                showStatus('削除に失敗しました: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function showStatus(message, type) {
            const existingMsg = document.querySelector('.status-message');
            if (existingMsg) {
                existingMsg.remove();
            }

            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';

            document.querySelector('.submit-section').appendChild(statusDiv);

            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.remove();
                }
            }, 3000);
        }

        function getPartyName(party) {
            const names = {
                'jimin': '自民', 'ishin': '維新', 'chudo': '中道',
                'kokumin': '国民', 'sansei': '参政', 'shamin': '社民',
                'kyosan': '共産', 'reiwa': 'れいわ', 'hoshu': '保守',
                'genzei': '減税', 'mirai': 'みらい', 'yukoku': '憂国', 'musho': '無諸'
            };
            return names[party] || party;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 输入事件监听
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', calculateTotals);
        });

        // 页面加载时获取数据
        document.addEventListener('DOMContentLoaded', function() {
            calculateTotals();
            displaySubmissions();
        });
    </script>
</body>
</html>
