<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>总席位预测 (Firebase)</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "Hiragino Kaku Gothic Pro", "Meiryo", sans-serif;
    background-color: #202020;
    color: #e0e0e0;
    padding: 20px;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #404040;
}

.back-btn {
    display: inline-block;
    margin-bottom: 20px;
    padding: 10px 20px;
    background-color: #404040;
    color: #e0e0e0;
    text-decoration: none;
    border-radius: 5px;
    transition: background-color 0.3s;
}

.back-btn:hover {
    background-color: #6090c0;
}

h1 {
    margin: 20px 0;
}

.table-container {
    max-width: 1200px;
    margin: 0 auto;
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
}

th, td {
    padding: 12px;
    text-align: center;
    border: 1px solid #404040;
}

th {
    background-color: #303030;
    font-weight: bold;
    color: #ffffff;
}

tr:nth-child(even) {
    background-color: #2a2a2a;
}

.party-name {
    text-align: left !important;
    font-weight: bold;
}

input[type="number"] {
    width: 80px;
    padding: 8px;
    text-align: center;
    border: 1px solid #606060;
    background-color: #303030;
    color: #e0e0e0;
    border-radius: 4px;
    font-size: 16px;
}

input[type="number"]:focus {
    outline: none;
    border-color: #6090c0;
}

input[type="text"] {
    padding: 8px 12px;
    text-align: center;
    border: 1px solid #606060;
    background-color: #303030;
    color: #e0e0e0;
    border-radius: 4px;
    font-size: 16px;
    width: 200px;
}

input[type="text"]:focus {
    outline: none;
    border-color: #6090c0;
}

.total-cell {
    background-color: #404060;
    font-weight: bold;
}

.summary {
    margin-top: 40px;
    padding: 20px;
    background-color: #303030;
    border-radius: 10px;
}

.summary h2 {
    color: #6090c0;
    margin-bottom: 15px;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #404040;
}

.summary-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #6090c0;
}

.jimin { color: #E080A0; }
.ishin { color: #60C080; }
.chudo { color: #2080C0; }
.kokumin { color: #80E0E0; }
.sansei { color: #E08000; }
.shamin { color: #E0B070; }
.kyosan { color: #E04040; }
.reiwa { color: #E0D0A0; }
.hoshu { color: #8090B0; }
.genzei { color: #B040D0; }
.mirai { color: #E09090; }
.yukoku { color: #C0C0E0; }
.musho { color: #A08060; }

.reset-btn {
    margin-top: 20px;
    padding: 10px 30px;
    background-color: #604040;
    color: #e0e0e0;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s;
}

.reset-btn:hover {
    background-color: #806060;
}

.submit-section {
    margin-top: 30px;
    padding: 20px;
    background-color: #303030;
    border-radius: 10px;
    text-align: center;
}

.submit-section h2 {
    color: #6090c0;
    margin-bottom: 15px;
}

.submit-inputs {
    display: flex;
    justify-content: center;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
}

.submit-inputs label {
    font-size: 14px;
    margin-bottom: 5px;
    display: block;
}

.submit-btn {
    padding: 12px 30px;
    background-color: #6090c0;
    color: #ffffff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    margin-left: 15px;
    transition: background-color 0.3s;
}

.submit-btn:hover {
    background-color: #80b0d0;
}

.submissions-container {
    margin-top: 40px;
    padding: 20px;
    background-color: #303030;
    border-radius: 10px;
}

.submissions-container h2 {
    color: #6090c0;
    margin-bottom: 20px;
}

.submission-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.submission-table th {
    background-color: #404060;
    color: #ffffff;
    padding: 12px;
    text-align: center;
}

.submission-table td {
    padding: 10px;
    text-align: center;
    border: 1px solid #404040;
}

.submission-table td:first-child {
    text-align: left;
    font-weight: bold;
}

.submission-table tr:hover {
    background-color: #404040;
}

.delete-btn {
    padding: 5px 10px;
    background-color: #604040;
    color: #e0e0e0;
    border: none;
    border-radius: 3px;
    cursor: pointer;
    font-size: 12px;
    margin-left: 10px;
}

.delete-btn:hover {
    background-color: #804040;
}

.empty-message {
    text-align: center;
    padding: 30px;
    color: #808080;
    font-size: 14px;
}
</style>
</head>
<body>
    <div class="header">
        <a href="index.html" class="back-btn">← 戻る</a>
        <h1>总席位预测</h1>
    </div>

    <div class="table-container">
        <table id="seatsTable">
            <thead>
                <tr>
                    <th>政党</th>
                    <th>選挙区</th>
                    <th>比例区</th>
                    <th class="total-cell">総計</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="party-name jimin">自由民主党</td>
                    <td><input type="number" class="senkyoku" data-party="jimin" value="0"></td>
                    <td><input type="number" class="hirei" data-party="jimin" value="0"></td>
                    <td class="total-cell" id="total-jimin">0</td>
                </tr>
                <tr>
                    <td class="party-name ishin">日本維新の会</td>
                    <td><input type="number" class="senkyoku" data-party="ishin" value="0"></td>
                    <td><input type="number" class="hirei" data-party="ishin" value="0"></td>
                    <td class="total-cell" id="total-ishin">0</td>
                </tr>
                <tr>
                    <td class="party-name chudo">中道改革連合</td>
                    <td><input type="number" class="senkyoku" data-party="chudo" value="0"></td>
                    <td><input type="number" class="hirei" data-party="chudo" value="0"></td>
                    <td class="total-cell" id="total-chudo">0</td>
                </tr>
                <tr>
                    <td class="party-name kokumin">国民民主党</td>
                    <td><input type="number" class="senkyoku" data-party="kokumin" value="0"></td>
                    <td><input type="number" class="hirei" data-party="kokumin" value="0"></td>
                    <td class="total-cell" id="total-kokumin">0</td>
                </tr>
                <tr>
                    <td class="party-name sansei">参政党</td>
                    <td><input type="number" class="senkyoku" data-party="sansei" value="0"></td>
                    <td><input type="number" class="hirei" data-party="sansei" value="0"></td>
                    <td class="total-cell" id="total-sansei">0</td>
                </tr>
                <tr>
                    <td class="party-name shamin">社会民主党</td>
                    <td><input type="number" class="senkyoku" data-party="shamin" value="0"></td>
                    <td><input type="number" class="hirei" data-party="shamin" value="0"></td>
                    <td class="total-cell" id="total-shamin">0</td>
                </tr>
                <tr>
                    <td class="party-name kyosan">日本共産党</td>
                    <td><input type="number" class="senkyoku" data-party="kyosan" value="0"></td>
                    <td><input type="number" class="hirei" data-party="kyosan" value="0"></td>
                    <td class="total-cell" id="total-kyosan">0</td>
                </tr>
                <tr>
                    <td class="party-name reiwa">れいわ新選組</td>
                    <td><input type="number" class="senkyoku" data-party="reiwa" value="0"></td>
                    <td><input type="number" class="hirei" data-party="reiwa" value="0"></td>
                    <td class="total-cell" id="total-reiwa">0</td>
                </tr>
                <tr>
                    <td class="party-name hoshu">日本保守党</td>
                    <td><input type="number" class="senkyoku" data-party="hoshu" value="0"></td>
                    <td><input type="number" class="hirei" data-party="hoshu" value="0"></td>
                    <td class="total-cell" id="total-hoshu">0</td>
                </tr>
                <tr>
                    <td class="party-name genzei">減税·憂国</td>
                    <td><input type="number" class="senkyoku" data-party="genzei" value="0"></td>
                    <td><input type="number" class="hirei" data-party="genzei" value="0"></td>
                    <td class="total-cell" id="total-genzei">0</td>
                </tr>
                <tr>
                    <td class="party-name mirai">チームみらい</td>
                    <td><input type="number" class="senkyoku" data-party="mirai" value="0"></td>
                    <td><input type="number" class="hirei" data-party="mirai" value="0"></td>
                    <td class="total-cell" id="total-mirai">0</td>
                </tr>
                <tr>
                    <td class="party-name musho">無所属等</td>
                    <td><input type="number" class="senkyoku" data-party="musho" value="0"></td>
                    <td><input type="number" class="hirei" data-party="musho" value="0"></td>
                    <td class="total-cell" id="total-musho">0</td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td class="party-name">合計</td>
                    <td id="total-senkyoku-sum">0</td>
                    <td id="total-hirei-sum">0</td>
                    <td class="total-cell" id="grand-total">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="summary">
            <h2>サマリー</h2>
            <div class="summary-row">
                <span>選挙区席数:</span>
                <span class="summary-value" id="summary-senkyoku">0</span>
            </div>
            <div class="summary-row">
                <span>比例区席数:</span>
                <span class="summary-value" id="summary-hirei">0</span>
            </div>
            <div class="summary-row">
                <span>総獲得席数:</span>
                <span class="summary-value" id="summary-total">0</span>
            </div>
            <div class="summary-row">
                <span>残り席数 (465):</span>
                <span class="summary-value" id="summary-remaining">465</span>
            </div>
        </div>

        <button class="reset-btn" onclick="resetAll()">リセット</button>
    </div>

    <div class="submit-section">
        <h2>予想を提出する</h2>
        <div class="submit-inputs">
            <div>
                <label>这里填网名</label>
                <input type="text" id="submitterName" placeholder="氏名を入力してください">
            </div>
            <div>
                <label>这里填自定义密码</label>
                <input type="password" id="submitterPassword" placeholder="予想更新用パスワードを入力">
            </div>
            <button class="submit-btn" onclick="submitPrediction()">提出する</button>
        </div>
        <p style="font-size: 12px; color: #a0a0a0; margin-top: 10px; text-align: center;">
            ※初回提出時に入力したパスワードで登録されます。同じ氏名で再提出する場合はパスワードが必要です。
        </p>
    </div>

    <div class="submissions-container">
        <h2>他の人の予想</h2>
        <div id="submissionsContent"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCMhXczea-LUNSbw9A70vYiCIoxopLTAd8",
            authDomain: "senkyo-prediction-2026.firebaseapp.com",
            projectId: "senkyo-prediction-2026",
            storageBucket: "senkyo-prediction-2026.firebasestorage.app",
            messagingSenderId: "406771519192",
            appId: "1:406771519192:web:c5b37f59657e07c3f011ad",
            measurementId: "G-N8Q2SPGC6Z"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = 'total_predictions';

        const parties = ['jimin', 'ishin', 'chudo', 'kokumin', 'sansei', 'shamin', 'kyosan', 'reiwa', 'hoshu', 'genzei', 'mirai', 'musho'];

        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', calculateTotals);
        });

        function calculateTotals() {
            let senkyokuTotal = 0;
            let hireiTotal = 0;
            let grandTotal = 0;

            parties.forEach(party => {
                const senkyoku = parseInt(document.querySelector(`.senkyoku[data-party="${party}"]`).value) || 0;
                const hirei = parseInt(document.querySelector(`.hirei[data-party="${party}"]`).value) || 0;
                const total = senkyoku + hirei;

                document.getElementById(`total-${party}`).textContent = total;
                senkyokuTotal += senkyoku;
                hireiTotal += hirei;
                grandTotal += total;
            });

            document.getElementById('total-senkyoku-sum').textContent = senkyokuTotal;
            document.getElementById('total-hirei-sum').textContent = hireiTotal;
            document.getElementById('grand-total').textContent = grandTotal;

            document.getElementById('summary-senkyoku').textContent = senkyokuTotal;
            document.getElementById('summary-hirei').textContent = hireiTotal;
            document.getElementById('summary-total').textContent = grandTotal;
            document.getElementById('summary-remaining').textContent = 465 - grandTotal;

            const remaining = 465 - grandTotal;
            const remainingEl = document.getElementById('summary-remaining');
            if (remaining < 0) {
                remainingEl.style.color = '#E04040';
            } else if (remaining > 0) {
                remainingEl.style.color = '#6090c0';
            } else {
                remainingEl.style.color = '#60C080';
            }
        }

        function resetAll() {
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = 0;
            });
            document.getElementById('submitterName').value = '';
            document.getElementById('submitterPassword').value = '';
            calculateTotals();
        }

        // 簡易的なパスワードハッシュ関数
        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'hashed_' + Math.abs(hash).toString(36) + '_' + btoa(password.substring(0, 3));
        }

        async function submitPrediction() {
            const name = document.getElementById('submitterName').value.trim();
            const password = document.getElementById('submitterPassword').value.trim();

            if (!name) {
                alert('氏名を入力してください');
                return;
            }

            if (!password) {
                alert('パスワードを入力してください');
                return;
            }

            try {
                const prediction = {};
                parties.forEach(party => {
                    const senkyoku = parseInt(document.querySelector(`.senkyoku[data-party="${party}"]`).value) || 0;
                    const hirei = parseInt(document.querySelector(`.hirei[data-party="${party}"]`).value) || 0;
                    prediction[party] = { senkyoku, hirei, total: senkyoku + hirei };
                });
                prediction.grandTotal = parseInt(document.getElementById('grand-total').textContent);
                prediction.senkyokuTotal = parseInt(document.getElementById('total-senkyoku-sum').textContent);
                prediction.hireiTotal = parseInt(document.getElementById('total-hirei-sum').textContent);

                const q = query(collection(db, COLLECTION_NAME), where('name', '==', name));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // 既存の予想がある場合
                    const existingDoc = querySnapshot.docs[0];
                    const existingData = existingDoc.data();

                    // パスワードが設定されているか確認
                    if (existingData.password) {
                        const inputPasswordHash = hashPassword(password);
                        if (inputPasswordHash !== existingData.password) {
                            alert('パスワードが違います。予想を更新するには正しいパスワードを入力してください。');
                            return;
                        }
                    }

                    await setDoc(existingDoc.ref, {
                        name: name,
                        prediction: prediction,
                        password: hashPassword(password),
                        timestamp: new Date().toISOString()
                    }, { merge: true });
                    alert('予想を更新しました！');
                } else {
                    // 新規予想の場合
                    await addDoc(collection(db, COLLECTION_NAME), {
                        name: name,
                        prediction: prediction,
                        password: hashPassword(password),
                        timestamp: new Date().toISOString()
                    });
                    alert('予想を保存しました！');
                }

                await displaySubmissions();

                // パスワード入力欄をクリア
                document.getElementById('submitterPassword').value = '';
            } catch (error) {
                console.error('Error:', error);
                alert('エラーが発生しました: ' + error.message);
            }
        }

        async function displaySubmissions() {
            try {
                const snapshot = await getDocs(collection(db, COLLECTION_NAME));
                const submissionsDiv = document.getElementById('submissionsContent');

                // サンプルデータ（Firebaseにデータがない場合や追加で表示する場合）
                const samplePredictions = [
                    {
                        name: 'サンプル予想A',
                        prediction: {
                            jimin: { senkyoku: 180, hirei: 70, total: 250 },
                            ishin: { senkyoku: 50, hirei: 30, total: 80 },
                            chudo: { senkyoku: 30, hirei: 20, total: 50 },
                            kokumin: { senkyoku: 20, hirei: 15, total: 35 },
                            sansei: { senkyoku: 10, hirei: 10, total: 20 },
                            shamin: { senkyoku: 1, hirei: 2, total: 3 },
                            kyosan: { senkyoku: 8, hirei: 7, total: 15 },
                            reiwa: { senkyoku: 3, hirei: 4, total: 7 },
                            hoshu: { senkyoku: 2, hirei: 2, total: 4 },
                            genzei: { senkyoku: 1, hirei: 1, total: 2 },
                            mirai: { senkyoku: 0, hirei: 0, total: 0 },
                            yukoku: { senkyoku: 0, hirei: 1, total: 1 },
                            musho: { senkyoku: 0, hirei: 0, total: 0 },
                            grandTotal: 465,
                            senkyokuTotal: 305,
                            hireiTotal: 160
                        },
                        timestamp: new Date('2026-01-25T10:00:00').toISOString()
                    },
                    {
                        name: 'サンプル予想B',
                        prediction: {
                            jimin: { senkyoku: 170, hirei: 65, total: 235 },
                            ishin: { senkyoku: 60, hirei: 35, total: 95 },
                            chudo: { senkyoku: 25, hirei: 18, total: 43 },
                            kokumin: { senkyoku: 25, hirei: 18, total: 43 },
                            sansei: { senkyoku: 8, hirei: 8, total: 16 },
                            shamin: { senkyoku: 1, hirei: 1, total: 2 },
                            kyosan: { senkyoku: 7, hirei: 6, total: 13 },
                            reiwa: { senkyoku: 2, hirei: 3, total: 5 },
                            hoshu: { senkyoku: 1, hirei: 1, total: 2 },
                            genzei: { senkyoku: 1, hirei: 1, total: 2 },
                            mirai: { senkyoku: 0, hirei: 0, total: 0 },
                            yukoku: { senkyoku: 0, hirei: 2, total: 2 },
                            musho: { senkyoku: 0, hirei: 0, total: 0 },
                            grandTotal: 456,
                            senkyokuTotal: 299,
                            hireiTotal: 157
                        },
                        timestamp: new Date('2026-01-25T12:00:00').toISOString()
                    }
                ];

                const allPredictions = [];

                // Firebaseから取得したデータを追加
                if (!snapshot.empty) {
                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        allPredictions.push({
                            name: data.name,
                            prediction: data.prediction,
                            timestamp: data.timestamp
                        });
                    });
                }

                // Firebaseにデータがない場合のみサンプルデータを追加
                if (allPredictions.length === 0) {
                    allPredictions.push(...samplePredictions);
                }

                allPredictions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                let html = '<table class="submission-table"><thead><tr><th>氏名</th><th>日時</th><th>自民</th><th>維新</th><th>中道</th><th>国民</th><th>参政</th><th>社民</th><th>共産</th><th>れいわ</th><th>保守</th><th>減税·憂国</th><th>みらい</th><th>無所属</th><th>総計</th></tr></thead><tbody>';

                allPredictions.forEach(data => {
                    const prediction = data.prediction;
                    const pred = prediction;
                    const date = new Date(data.timestamp).toLocaleString('ja-JP');

                    // 合并genzei和yukoku的值（历史数据中可能存在yukoku）
                    const genzeiTotal = (pred.genzei?.total || 0) + (pred.yukoku?.total || 0);

                    html += `<tr>
                        <td>${escapeHtml(data.name)}</td>
                        <td>${date}</td>
                        <td class="jimin">${pred.jimin.total}</td>
                        <td class="ishin">${pred.ishin.total}</td>
                        <td class="chudo">${pred.chudo.total}</td>
                        <td class="kokumin">${pred.kokumin.total}</td>
                        <td class="sansei">${pred.sansei.total}</td>
                        <td class="shamin">${pred.shamin.total}</td>
                        <td class="kyosan">${pred.kyosan.total}</td>
                        <td class="reiwa">${pred.reiwa.total}</td>
                        <td class="hoshu">${pred.hoshu.total}</td>
                        <td class="genzei">${genzeiTotal}</td>
                        <td class="mirai">${pred.mirai.total}</td>
                        <td class="musho">${pred.musho.total}</td>
                        <td><strong>${pred.grandTotal}</strong></td>
                        <td><button class="delete-btn" onclick="deleteSubmission('${escapeHtml(data.name)}')">削除</button></td>
                    </tr>`;
                });

                html += '</tbody></table>';
                submissionsDiv.innerHTML = html;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteSubmission(name) {
            // パスワード入力を促す
            const password = prompt(`${name} さんの予想を削除します。\nパスワードを入力してください：`);

            if (password === null) {
                // キャンセルされた場合
                return;
            }

            if (password.trim() === '') {
                alert('パスワードが入力されていません');
                return;
            }

            try {
                const q = query(collection(db, COLLECTION_NAME), where('name', '==', name));
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    const data = doc.data();

                    // パスワードが設定されているか確認
                    if (data.password) {
                        const inputPasswordHash = hashPassword(password.trim());
                        if (inputPasswordHash !== data.password) {
                            alert('パスワードが違います。削除するには正しいパスワードを入力してください。');
                            return;
                        }
                    }

                    await deleteDoc(doc.ref);
                    await displaySubmissions();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('削除に失敗しました: ' + error.message);
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.addEventListener('DOMContentLoaded', function() {
            calculateTotals();
            displaySubmissions();
        });

        window.submitPrediction = submitPrediction;
        window.deleteSubmission = deleteSubmission;
    </script>
</body>
</html>
